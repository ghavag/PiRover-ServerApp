#!/usr/bin/python

# Dienstprogramm fuer den PiRover zur Ausfuehrung auf der Raspberry Pi.
#
# Autor: Alexander Graeb <mail@hpvag.de>

### Konfigurationskonstanten. ###

LISTEN_ADDRESS = ""
LISTEN_PORT = 1987

# Zeichenfolge, welche zur Authentifizierung des Clients dient.
SECRET = "uMieY6ophu[a"

### Programm startet hier.
import socket
import time
import md5

print "PiRover server started."


s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((LISTEN_ADDRESS, LISTEN_PORT))
s.listen(1)

try:
	while True:
		c, c_address = s.accept()
		print "Client connected from %s." % (c_address[0])

		while True:
			# Warte darauf, dass Client das Zauberwort sagt.
			data = c.recv(1024)

			if not data:
				c.close()
				break

			print "Received data from client: %s" % (data)

			# Begruesse Client und sende Salz fuer den Authentifizierungs-Hash mit.
			authsalt = str(time.time())

			if (data == 'Hello PiRover!\n'):
				c.send("PiRover 1.0 here! %s\n" % (authsalt))
			else:
				c.close()
				break

			# Warte darauf, dass sich Client authentifiziert.
			data = c.recv(1024)

			if not data:
				c.close()
				break

			print "Received data from client: %s" % (data)

			if (data == (md5.new(SECRET + authsalt).hexdigest() + "\n")):
				print "Client auth ok!"
				c.send("OK\n");
			else:
				print "Auth failed!"
				c.close()
				break

			data = c.recv(1024)

			while (data):
				print "Received data from client: %s" % (data)
				data = c.recv(1024)

		print "Connection to client %s closed." % c_address[0]
finally:
	s.close()

